{% import 'book_helpers.html' as helpers with context %}

{# layout.html settings #}
{% set page_title = 'Books' %}
{% set active_page = 'books_index' %}
{% extends "layout.html" %}
{% block head %}

{% endblock %}
{% block body %}
<br>
<div class="panel panel-default">
  <!-- Default panel contents -->
  <div class="panel-heading">
    <button id="sorting_toggle_btn" type="button" class="btn btn-default pull-right" aria-label="Left Align">
      <span class="glyphicon glyphicon-filter" aria-hidden="true"></span> Sorting
    </button>
    <h4>Books</h4>
  </div>
        <div id="table_sorting_options" class="well">


        {{ helpers.sort_button("Title","book_title") }}
        {{ helpers.sort_button("Publication Date","publication_date") }}
        {{ helpers.sort_button("Avg. Rating","avg_rating") }}
        {{ helpers.sort_button("Number of Readers","num_readers") }}
        {% if sorting %}
            <div class="btn-group">
              <a href="{{url_for('books_index')}}" type="button" class="btn btn-warning"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Disable Sorting</a>
            </div>
        {% endif %}
        </div>
    {{ navigation.paginator('books_index','pull-right') }}
  <!-- Table -->
  <table class="table">
    <thead><tr>
        <th>Cover</th><th>Title</th><th>Author</th><th>Avg. Rating</th><th>Tags</th><th>Actions</th>
        {% if current_user.is_authenticated() %}

        {% endif %}
    </tr></thead>
    <tbody>
    <tr>
        <td><img src="{{ url_for('static', filename='images/blank_cover_100-88.png') }}"</td>
        <td>Example Title</td>
        <td>Example Author</td>
        <td style="width:250px;">
            <div style="vertical-align: middle;">{{ helpers.star_ratings(0,0) }} <span style="padding-top:15px;">(avg. 2.5)</span></div>
            <hr class="listing-cell-divider" />
            <p class="text-muted"><span class="glyphicon glyphicon-remove" aria-hidden="true" data-toggle="modal"></span>Your rating: 4</p>
        </td>
        <td>
            <span class="label label-default">Tag 1</span>
            <span class="label label-default">Tag 2</span>
            <span class="label label-default">Tag 3</span>
        </td>
        <td>
        {% if current_user.is_authenticated() %}


            <div class="btn-group">
                  <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    Add<span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu">
                    <li><a href="{{ url_for('add_review', bid=1)}}?next={{ request.path }}">Review</a></li>
                      <li><a href="#" class="add_to_shelf" data-id="1" data-title="Example" data-toggle="modal" data-target="#bookModal">Reading Log</a></li>
                  <li class="divider"></li>

                    <li><a href="#" class="add_to_list" data-id="1" data-title="Example" data-toggle="modal" data-target="#bookModal">List</a></li>
                  </ul>
                </div>
        {% endif %}
            <div class="btn-group">

                  <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    View<span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu">


                    <li><a href="{{ url_for('view_review',bid=0) }}">Reviews</a></li>
                    <li><a href="#">Lists</a></li>
                    <li class="divider"></li>
                    <li><a href="#">View Lists Containing</a></li>
                  </ul>
                </div>
        </td>


    </tr>
    {% for book in books %}
    <tr>
        <td><img src="{{ url_for('static', filename='images/blank_cover_100-88.png') }}"/></td>
        <td><a href="{{ url_for('display_book', bid=book.core_id)}}?next={{ request.path }}?page={{ page }}">{{ book.title }}</a></td>
        <td>
	  {% for author in book.authors %}
	  {{ author.name }}
	  {% endfor %}
	</td>
        <td style="width:250px;">
            <div style="vertical-align: middle;">{{ helpers.star_ratings(book.core_id,book.discrete_rating) }} <span style="padding-top:15px;">(avg. {{ book.avg_rating }})</span></div>
            <hr class="listing-cell-divider" />
            {% if book.user_rating %}<p class="text-muted"><a href="{{url_for('remove_book_rating', bid=book.core_id)}}" ><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>Your rating: {{ book.user_rating }}</p> {% endif %}
        </td>
        <td>
            {% for subject in book.subjects %}
            <a href="{{url_for('books_by_subject',subject=subject)}}"><span class="label label-default">{{ subject }}</span></a>&nbsp;
            {% endfor %}
        </td>
        <td>
        {% if current_user.is_authenticated() %}


            <div class="btn-group">
                  <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    Add<span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu">
                    <li><a href="{{ url_for('add_review', bid=book.core_id)}}?next={{ request.path }}">Review</a></li>
                    <li><a href="#" class="add_to_shelf" data-id="{{ book.core_id }}" data-title="{{ book.title }}" data-toggle="modal" data-target="#bookModal">Reading Log</a></li>
                    <li class="divider"></li>
                    <li><a href="#" class="add_to_list" data-id="{{ book.core_id }}" data-title="{{ book.title }}" data-toggle="modal" data-target="#bookModal">To List</a></li>
                    <li class="divider"></li>
                    <li><a href="#" class="add_to_list" data-id="{{ book.core_id }}" data-title="{{ book.title }}" data-toggle="modal" data-target="#bookModal">Book Details</a></li>
                  </ul>
                </div>
        {% endif %}
            <div class="btn-group">

                  <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    View<span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu">


                    <li><a href="{{ url_for('view_review',bid=book.core_id) }}">Reviews</a></li>
                    <li><a href="#">Lists</a></li>
                    <li class="divider"></li>
                    <li><a href="#">View Lists Containing</a></li>
                  </ul>
                </div>
        </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>

    {{ navigation.paginator('books_index') }}
</div>

            <div class="modal fade" id="pleaseWaitDialog" role="dialog" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h1 id="pleaseWaitDialogHeading">Processing...</h1>
        </div>
        <div class="modal-body">
            <div class="progress progress-striped active">
                <div class="progress-bar" role="progressbar" style="width: 100%;"></div>
            </div>
        </div>
    </div>
                        </div>
</div>

<!-- Shelf Modal -->
<div class="modal fade" id="bookModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="bookModalBookTitle">Modal title</h4>
      </div>

      <div class="modal-body" id="bookModalBody">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="bookModalSubmit">Save changes</button>
      </div>

    </div>
  </div>
</div>
<!-- /Shelf Modal -->


<div id="shelfForm" class="hidden">
             <form action="{{ url_for('add_reading_log') }}?next={{ request.path }}" method="POST" role="form" id="bookModalForm">
            <div class="form-group">
                <div class='input-group date' id='starting_date'>
                    <input type='text' class="form-control" placeholder="Starting Date" />
                    <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
            <div class="form-group">
                <div class='input-group date' id='completed_date'>
                    <input type='text' class="form-control" placeholder="Starting Date" />
                    <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
            <p class="help-block">Please enter your log entry below!</p>
            <label for="log_input" class="sr-only">Reading Log</label>
            <textarea name="log_input" id="log_input" class="form-control" rows="5" required autofocus></textarea>
         </form>
         <hr />
          <h4><a href="{{ url_for('user_dashboard') }}?section=logs#logs">Previous Logs</a></h4>
          <table class="table">
              <thead>
              <tr>
              <th>Date Completed</th><th>Date Started</th><th>Log</th>
              </tr>
              </thead>
              <tbody>

              </tbody>
          </table>

</div>

<div id="listForm" class="hidden">

<h4>Add to Existing List</h4>
            <form action="{{ url_for('add_book_list') }}?next={{ request.path }}" method="POST" role="form" id="listModalForm">
         </form>
    <hr />
<h4>Add to New List</h4>



</div>
{% endblock %}


{% block footer_scripts %}
<script type="text/javascript">
$(window).load(function(){
    //$(document).ready(function(){
        {% if not sorting %}
      $('#table_sorting_options').toggleClass('hidden');
        {% else %}
        $('#sorting_toggle_btn').toggleClass('active');
        {% endif %}
      $('#sorting_toggle_btn').click(function(){
        $('#table_sorting_options').toggleClass('hidden');
        $(this).toggleClass('active');


      });
      $('.rating-star').click(function(){
        var value = $(this).attr('value');
        var book_id = $(this).attr('book_id');
        console.debug("Rating clicked -- value: "+value+" -- book_id: "+book_id);
          $("#pleaseWaitDialog").modal('show')
        $(this).closest("form").submit();

    });
    $("#bookModalSubmit").click(function(){
        $("#bookModalForm").submit();
    });

            //http://eonasdan.github.io/bootstrap-datetimepicker
    $("#starting_date").datetimepicker({
					pickTime: false
				});
        $("#completed_date").datetimepicker({
					pickTime: false
				});
    $(".add_to_shelf").click(function () {

     var currentID = $(this).data('id');
     var currentTitle = $(this).data('title');
     $("#bookModalBookId").val( currentID );
//        console.log($(this));
     $("#bookModalBookTitle").html( currentTitle );
     $("#bookModalBody").html($("#shelfForm").html())
//        $.ajax() -- load logs?
     // As pointed out in comments,
     // it is superfluous to have to manually call the modal.
     // $('#addBookDialog').modal('show');
    });
    $(".add_to_list").click(function() {
             var currentID = $(this).data('id');
     var currentTitle = $(this).data('title');
     $("#bookModalBookId").val( currentID );
//        console.log($(this));
     $("#bookModalBookTitle").html( currentTitle + ' - Add to List' );
     $("#bookModalBody").html($("#listForm").html())

    });
});

</script>
{% endblock %}